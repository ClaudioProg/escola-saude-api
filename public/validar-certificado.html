<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Valida√ß√£o de Certificado</title>
  <style>
    body { background:#e8f0e3; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding:40px 20px; text-align:center; }
    .logo { width:120px; margin-bottom:20px; }
    .container { background:#2e4b2e; color:#fff; border-radius:10px; padding:30px; box-shadow:0 0 15px rgba(0,0,0,.2); max-width:700px; margin:auto; font-size:18px; animation:fadeIn .6s ease; }
    h1 { font-size:28px; margin-bottom:20px; color:#fff; }
    .info p { margin:10px 0; white-space:pre-wrap; }
    .erro { color:#ffaaaa; font-weight:bold; }
    #printButton { margin-top:30px; background:#4CAF50; color:#fff; border:none; padding:10px 20px; font-size:16px; cursor:pointer; border-radius:6px; }
    #printButton[disabled] { opacity:.6; cursor:not-allowed; }
    #printButton:hover { background:#45a049; }
    @keyframes fadeIn { from{opacity:0; transform:translateY(-10px)} to{opacity:1; transform:translateY(0)} }
  </style>
</head>
<body>
  <img src="/logo_escola.png" alt="Logo da Escola da Sa√∫de" class="logo"/>

  <div class="container" role="region" aria-live="polite">
    <h1>Valida√ß√£o de Certificado</h1>
    <div class="info" id="info">
      <p>Verificando...</p>
    </div>
  </div>

  <button id="printButton" onclick="window.print()">üñ®Ô∏è Imprimir Certifica√ß√£o</button>

  <script>
    (function () {
      const params = new URLSearchParams(window.location.search);
      const usuario_id = params.get("usuario_id");
      const evento_id  = params.get("evento_id");

      // Permite sobrepor a base da API via query (?api_base=https://...).
      // Padr√£o: produ√ß√£o HTTPS.
      const DEFAULT_API_BASE = "https://escola-saude-api.onrender.com";
      const apiBase = (params.get("api_base") || DEFAULT_API_BASE).replace(/\/+$/,"");

      const infoDiv = document.getElementById("info");
      const printBtn = document.getElementById("printButton");

      // Acessibilidade: desabilita imprimir enquanto carrega
      printBtn.disabled = true;

      function formatarDataBrasileira(iso) {
        if (!iso) return "";
        const d = new Date(iso);
        if (Number.isNaN(d.getTime())) return "";
        return d.toLocaleDateString("pt-BR", { timeZone: "America/Sao_Paulo" });
      }

      function p(txt, strong=false) {
        const el = document.createElement("p");
        if (strong) {
          const b = document.createElement("strong");
          b.textContent = txt;
          el.appendChild(b);
        } else {
          el.textContent = txt;
        }
        return el;
      }

      function linhaRotulo(rotulo, valor) {
        const el = document.createElement("p");
        const b  = document.createElement("strong");
        b.textContent = rotulo + ": ";
        el.appendChild(b);
        el.appendChild(document.createTextNode(valor || ""));
        return el;
      }

      function erro(msg) {
        infoDiv.innerHTML = "";
        const el = p(msg);
        el.className = "erro";
        infoDiv.appendChild(el);
        printBtn.disabled = true;
      }

      if (!usuario_id || !evento_id) {
        erro("Par√¢metros inv√°lidos na URL.");
        return;
      }

      // Monta URL segura
      const url = `${apiBase}/api/certificados/validar-certificado?usuario_id=${encodeURIComponent(usuario_id)}&evento_id=${encodeURIComponent(evento_id)}`;

      // Bloqueia mixed content (se p√°gina estiver em https, a API tamb√©m deve estar)
      if (location.protocol === "https:" && url.startsWith("http://")) {
        erro("N√£o foi poss√≠vel validar (Mixed Content). Verifique a URL da API (use HTTPS).");
        return;
      }

      fetch(url, { credentials: "include" })
        .then(async (res) => {
          // Tenta JSON mesmo em erro para capturar mensagem do backend
          let data = null;
          try { data = await res.json(); } catch { /* corpo n√£o-JSON */ }

          if (!res.ok) {
            const msg = (data && (data.erro || data.message)) || `Erro HTTP ${res.status}`;
            throw new Error(msg);
          }
          return data;
        })
        .then((data) => {
          infoDiv.innerHTML = "";
          if (data && data.valido) {
            infoDiv.appendChild(p("‚úÖ Certificado v√°lido", true));
            infoDiv.appendChild(linhaRotulo("Nome", data.usuario || ""));
            infoDiv.appendChild(linhaRotulo("CPF",  data.cpf || ""));
            infoDiv.appendChild(linhaRotulo("Evento", data.evento || ""));
            const periodo = (data.periodo && data.periodo.inicio && data.periodo.fim)
              ? `${formatarDataBrasileira(data.periodo.inicio)} a ${formatarDataBrasileira(data.periodo.fim)}`
              : "";
            infoDiv.appendChild(linhaRotulo("Per√≠odo", periodo));
            infoDiv.appendChild(linhaRotulo("Emitido em", formatarDataBrasileira(data.gerado_em)));

            // Libera impress√£o
            printBtn.disabled = false;
          } else {
            erro("‚ùå Certificado n√£o encontrado.");
          }
        })
        .catch((e) => {
          console.error(e);
          erro("Erro ao validar o certificado. Tente novamente mais tarde.");
        });
    })();
  </script>
</body>
</html>
