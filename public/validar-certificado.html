<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Valida√ß√£o de Certificado</title>

  <!-- Evita indexa√ß√£o -->
  <meta name="robots" content="noindex, nofollow"/>

  <style>
    :root {
      --verde-escuro:#2e4b2e;
      --verde-botao:#4CAF50;
      --verde-botao-hover:#45a049;
      --bg:#e8f0e3;
      --erro:#ffaaaa;
      --txt:#ffffff;
      --sombra:0 0 15px rgba(0,0,0,.2);
    }
    html,body { height:100%; }
    body {
      background:var(--bg);
      font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding:40px 20px;
      text-align:center;
      color:#111;
    }
    .logo { width:120px; margin-bottom:20px; }
    .container {
      background:var(--verde-escuro);
      color:var(--txt);
      border-radius:10px;
      padding:30px;
      box-shadow:var(--sombra);
      max-width:700px;
      margin:auto;
      font-size:18px;
      animation:fadeIn .6s ease;
    }
    h1 { font-size:28px; margin-bottom:20px; color:var(--txt); }
    .info p { margin:10px 0; white-space:pre-wrap; }
    .erro { color:var(--erro); font-weight:bold; }
    #printButton {
      margin-top:30px; background:var(--verde-botao);
      color:#fff; border:none; padding:10px 20px;
      font-size:16px; cursor:pointer; border-radius:6px;
      transition:background .15s ease;
    }
    #printButton[disabled] { opacity:.6; cursor:not-allowed; }
    #printButton:hover:not([disabled]) { background:var(--verde-botao-hover); }
    @keyframes fadeIn { from{opacity:0; transform:translateY(-10px)} to{opacity:1; transform:translateY(0)} }

    /* Melhorias de impress√£o */
    @media print {
      body { background:#fff; padding:0; }
      .logo { display:none; }
      #printButton { display:none !important; }
      .container { box-shadow:none; border:1px solid #ccc; color:#000; }
    }
  </style>
</head>
<body>
  <img src="/logo_escola.png" alt="Logotipo da Escola da Sa√∫de" class="logo" />

  <div class="container" role="region" aria-live="polite" aria-atomic="true">
    <h1>Valida√ß√£o de Certificado</h1>
    <div class="info" id="info">
      <p>Verificando...</p>
    </div>
  </div>

  <button id="printButton" type="button" onclick="window.print()" disabled aria-disabled="true">
    üñ®Ô∏è Imprimir Certifica√ß√£o
  </button>

  <script>
    (function () {
      const params = new URLSearchParams(window.location.search);
      const usuario_id = params.get("usuario_id");
      const evento_id  = params.get("evento_id");

      // ‚õëÔ∏è Base da API (permite override por query ?api_base=...)
      const DEFAULT_API_BASE = "https://escola-saude-api.onrender.com";
      const apiBase = (params.get("api_base") || DEFAULT_API_BASE).replace(/\/+$/,"");

      const infoDiv = document.getElementById("info");
      const printBtn = document.getElementById("printButton");

      // Desabilita imprimir enquanto carrega
      setPrintEnabled(false);

      function setPrintEnabled(enabled) {
        printBtn.disabled = !enabled;
        printBtn.setAttribute("aria-disabled", String(!enabled));
      }

      // Datas SEM risco de "voltar um dia": usa fuso expl√≠cito
      function formatarDataBrasileira(iso) {
        if (!iso) return "";
        const d = new Date(iso);
        if (Number.isNaN(d.getTime())) return "";
        try {
          return new Intl.DateTimeFormat("pt-BR", {
            timeZone: "America/Sao_Paulo"
          }).format(d);
        } catch {
          // Fallback
          return d.toLocaleDateString("pt-BR");
        }
      }

      function p(txt, strong=false, cls="") {
        const el = document.createElement("p");
        if (cls) el.className = cls;
        if (strong) {
          const b = document.createElement("strong");
          b.textContent = txt;
          el.appendChild(b);
        } else {
          el.textContent = txt;
        }
        return el;
      }

      function linhaRotulo(rotulo, valor) {
        const el = document.createElement("p");
        const b  = document.createElement("strong");
        b.textContent = rotulo + ": ";
        el.appendChild(b);
        el.appendChild(document.createTextNode(valor || ""));
        return el;
      }

      function limparInfo() {
        while (infoDiv.firstChild) infoDiv.removeChild(infoDiv.firstChild);
      }

      function mostrarErro(msg) {
        limparInfo();
        infoDiv.appendChild(p(msg, false, "erro"));
        setPrintEnabled(false);
      }

      if (!usuario_id || !evento_id) {
        mostrarErro("‚ùå Par√¢metros inv√°lidos na URL.");
        return;
      }

      // Monta URL de forma segura
      const url = `${apiBase}/api/certificados/validar-certificado?usuario_id=${
        encodeURIComponent(usuario_id)
      }&evento_id=${encodeURIComponent(evento_id)}`;

      // Bloqueia mixed content em produ√ß√£o
      if (location.protocol === "https:" && url.startsWith("http://")) {
        mostrarErro("N√£o foi poss√≠vel validar (Mixed Content). Use uma URL de API com HTTPS.");
        return;
      }

      // Timeout com AbortController (robustez de rede)
      const controller = new AbortController();
      const idTimeout = setTimeout(() => controller.abort(), 15000); // 15s

      (async () => {
        try {
          const res = await fetch(url, {
            credentials: "include",
            signal: controller.signal,
            // Cabe√ßalho opcional se backend exigir JSON
            headers: { "Accept": "application/json" }
          });

          let data = null;
          try { data = await res.json(); } catch { /* pode n√£o ser JSON */ }

          if (!res.ok) {
            const msg = (data && (data.erro || data.message)) || `Erro HTTP ${res.status}`;
            throw new Error(msg);
          }

          limparInfo();

          if (data && (data.valido || data.presente === true)) {
            infoDiv.appendChild(p("‚úÖ Certificado v√°lido", true));
            infoDiv.appendChild(linhaRotulo("Nome", data.usuario || data.nome || ""));
            infoDiv.appendChild(linhaRotulo("CPF", data.cpf || ""));
            infoDiv.appendChild(linhaRotulo("Evento", data.evento || data.titulo || ""));

            // Per√≠odo pode vir como objeto {inicio,fim} ou strings
            let inicio = "", fim = "";
            if (data.periodo && (data.periodo.inicio || data.periodo.fim)) {
              inicio = formatarDataBrasileira(data.periodo.inicio);
              fim    = formatarDataBrasileira(data.periodo.fim);
            } else if (data.data_inicio || data.data_fim) {
              inicio = formatarDataBrasileira(data.data_inicio);
              fim    = formatarDataBrasileira(data.data_fim);
            }
            if (inicio || fim) {
              infoDiv.appendChild(linhaRotulo("Per√≠odo", `${inicio}${inicio && fim ? " a " : ""}${fim}`));
            }

            // Data de emiss√£o
            const emitido = formatarDataBrasileira(data.gerado_em || data.emitido_em);
            if (emitido) infoDiv.appendChild(linhaRotulo("Emitido em", emitido));

            setPrintEnabled(true);
          } else {
            mostrarErro("‚ùå Certificado n√£o encontrado ou inv√°lido.");
          }
        } catch (e) {
          if (e.name === "AbortError") {
            mostrarErro("‚è±Ô∏è Tempo de resposta excedido. Tente novamente.");
          } else {
            console.error(e);
            mostrarErro("‚ùå Erro ao validar o certificado. Tente novamente mais tarde.");
          }
        } finally {
          clearTimeout(idTimeout);
        }
      })();
    })();
  </script>
</body>
</html>
