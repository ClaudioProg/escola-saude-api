<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Valida√ß√£o de Certificado</title>

  <!-- Evita indexa√ß√£o -->
  <meta name="robots" content="noindex, nofollow"/>

  <style>
    :root {
      --verde-escuro:#2e4b2e;
      --verde-botao:#4CAF50;
      --verde-botao-hover:#45a049;
      --bg:#e8f0e3;
      --erro:#ffaaaa;
      --txt:#ffffff;
      --sombra:0 0 15px rgba(0,0,0,.2);
    }
    html,body { height:100%; }
    body {
      background:var(--bg);
      font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding:40px 20px;
      text-align:center;
      color:#111;
    }
    .logo { width:120px; margin-bottom:20px; }
    .container {
      background:var(--verde-escuro);
      color:var(--txt);
      border-radius:10px;
      padding:30px;
      box-shadow:var(--sombra);
      max-width:700px;
      margin:auto;
      font-size:18px;
      animation:fadeIn .6s ease;
    }
    h1 { font-size:28px; margin-bottom:20px; color:var(--txt); }
    .info p { margin:10px 0; white-space:pre-wrap; }
    .erro { color:var(--erro); font-weight:bold; }
    #printButton {
      margin-top:30px; background:var(--verde-botao);
      color:#fff; border:none; padding:10px 20px;
      font-size:16px; cursor:pointer; border-radius:6px;
      transition:background .15s ease;
    }
    #printButton[disabled] { opacity:.6; cursor:not-allowed; }
    #printButton:hover:not([disabled]) { background:var(--verde-botao-hover); }
    @keyframes fadeIn { from{opacity:0; transform:translateY(-10px)} to{opacity:1; transform:translateY(0)} }

    /* Melhorias de impress√£o */
    @media print {
      body { background:#fff; padding:0; }
      .logo { display:none; }
      #printButton { display:none !important; }
      .container { box-shadow:none; border:1px solid #ccc; color:#000; }
    }
  </style>
</head>
<body>
  <img src="/logo_escola.png" alt="Logotipo da Escola da Sa√∫de" class="logo" />

  <div class="container" role="region" aria-live="polite" aria-atomic="true">
    <h1>Valida√ß√£o de Certificado</h1>
    <div class="info" id="info">
      <p>Verificando...</p>
    </div>
  </div>

  <button id="printButton" type="button" onclick="window.print()" disabled aria-disabled="true">
    üñ®Ô∏è Imprimir Certifica√ß√£o
  </button>

  <script>
    (function () {
      // ---------- helpers ----------
      const isDateOnly = (s) => typeof s === "string" && /^\d{4}-\d{2}-\d{2}$/.test(s);
      const fmtDateOnlyBR = (ymd) => {
        if (!isDateOnly(ymd)) return "";
        const [y, m, d] = ymd.split("-");
        return `${d}/${m}/${y}`;
      };
      function formatarDataBrasileira(input) {
        if (!input) return "";
        if (typeof input === "string" && isDateOnly(input)) return fmtDateOnlyBR(input);
        const d = new Date(input);
        if (Number.isNaN(d.getTime())) return "";
        try {
          return new Intl.DateTimeFormat("pt-BR", { timeZone: "America/Sao_Paulo" }).format(d);
        } catch {
          return d.toLocaleDateString("pt-BR");
        }
      }
      function p(txt, strong=false, cls="") {
        const el = document.createElement("p");
        if (cls) el.className = cls;
        if (strong) { const b = document.createElement("strong"); b.textContent = txt; el.appendChild(b); }
        else el.textContent = txt;
        return el;
      }
      function linhaRotulo(rotulo, valor) {
        const el = document.createElement("p");
        const b  = document.createElement("strong");
        b.textContent = rotulo + ": ";
        el.appendChild(b);
        el.appendChild(document.createTextNode(valor || ""));
        return el;
      }
      function setPrintEnabled(enabled) {
        printBtn.disabled = !enabled;
        printBtn.setAttribute("aria-disabled", String(!enabled));
      }
      function parseParamsComLegado() {
        const out = {};
        const params = new URLSearchParams(window.location.search);
        // 1) direto da URL
        out.usuario_id = params.get("usuario_id") || params.get("usuario") || "";
        out.evento_id  = params.get("evento_id")  || params.get("evento")  || "";
        // 2) se vier como ?codigo=https://...?... embutido, mescla
        const codigo = params.get("codigo");
        if (codigo) {
          try {
            const u = new URL(decodeURIComponent(codigo));
            const inner = new URLSearchParams(u.search);
            out.usuario_id ||= inner.get("usuario_id") || inner.get("usuario") || "";
            out.evento_id  ||= inner.get("evento_id")  || inner.get("evento")  || "";
          } catch {}
        }
        // 3) turma_id pode existir, mas √© opcional para a valida√ß√£o
        out.turma_id = params.get("turma_id") || "";
        // 4) api_base opcional
        out.api_base = (params.get("api_base") || "").replace(/\/+$/,"");
        return out;
      }
  
      // ---------- DOM refs ----------
      const infoDiv  = document.getElementById("info");
      const printBtn = document.getElementById("printButton");
      setPrintEnabled(false);
  
      // ---------- coleta par√¢metros ----------
      const qp = parseParamsComLegado();
      if (!qp.usuario_id || !qp.evento_id) {
        infoDiv.innerHTML = "";
        infoDiv.appendChild(p("‚ùå Par√¢metros inv√°lidos na URL.", false, "erro"));
        return;
      }
  
      // ---------- API base (auto + fallback) ----------
      const FALLBACK_API = "https://escola-saude-api.onrender.com";
      const bases = [];
      if (qp.api_base) bases.push(qp.api_base);
      bases.push("/api", FALLBACK_API); // tenta mesma origem, depois fallback
  
      async function fetchValidacao(base) {
        const url = `${base.replace(/\/+$/,"")}/api/certificados/validar-certificado` +
                    `?usuario_id=${encodeURIComponent(qp.usuario_id)}` +
                    `&evento_id=${encodeURIComponent(qp.evento_id)}`;
        if (location.protocol === "https:" && url.startsWith("http://")) {
          throw new Error("mixed-content");
        }
        const controller = new AbortController();
        const timer = setTimeout(() => controller.abort(), 15000);
        try {
          const res = await fetch(url, { headers: { Accept: "application/json" }, signal: controller.signal });
          const data = await res.json().catch(() => ({}));
          if (!res.ok) throw new Error(data?.erro || data?.message || `HTTP ${res.status}`);
          return data;
        } finally {
          clearTimeout(timer);
        }
      }
  
      (async () => {
        let data = null, lastErr = null;
        for (const base of bases) {
          try { data = await fetchValidacao(base); break; }
          catch (e) { lastErr = e; }
        }
  
        infoDiv.innerHTML = "";
        if (!data) {
          if (lastErr && lastErr.message === "mixed-content") {
            infoDiv.appendChild(p("N√£o foi poss√≠vel validar (Mixed Content). Use uma URL de API com HTTPS.", false, "erro"));
          } else {
            infoDiv.appendChild(p("‚ùå Erro ao validar o certificado. Tente novamente mais tarde.", false, "erro"));
          }
          setPrintEnabled(false);
          return;
        }
  
        if (data.valido || data.presente === true) {
          infoDiv.appendChild(p("‚úÖ Certificado v√°lido", true));
          infoDiv.appendChild(linhaRotulo("Nome",   data.usuario || data.nome || ""));
          infoDiv.appendChild(linhaRotulo("CPF",    data.cpf || ""));
          infoDiv.appendChild(linhaRotulo("Evento", data.evento || data.titulo || ""));
  
          // per√≠odo: aceita {inicio,fim} ou data_inicio/data_fim ‚Äî preserva YYYY-MM-DD sem shift
          let ini = "", fim = "";
          if (data.periodo && (data.periodo.inicio || data.periodo.fim)) {
            ini = formatarDataBrasileira(data.periodo.inicio);
            fim = formatarDataBrasileira(data.periodo.fim);
          } else if (data.data_inicio || data.data_fim) {
            ini = formatarDataBrasileira(data.data_inicio);
            fim = formatarDataBrasileira(data.data_fim);
          }
          if (ini || fim) infoDiv.appendChild(linhaRotulo("Per√≠odo", `${ini}${ini && fim ? " a " : ""}${fim}`));
  
          const emitido = formatarDataBrasileira(data.gerado_em || data.emitido_em);
          if (emitido) infoDiv.appendChild(linhaRotulo("Emitido em", emitido));
  
          setPrintEnabled(true);
        } else {
          infoDiv.appendChild(p("‚ùå Certificado n√£o encontrado ou inv√°lido.", false, "erro"));
          setPrintEnabled(false);
        }
      })();
    })();
  </script>
</body>
</html>
