// üìÅ src/utils/data.js

// Timezone padr√£o para exibi√ß√£o/formatos locais.
// OBS: Somente para formata√ß√£o; o armazenamento/contrato de API continua em UTC.
const TZ_PADRAO = process.env.TZ_PADRAO || "America/Sao_Paulo";

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   VALIDADORES / PARSERS B√ÅSICOS
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

/** Retorna true se for string no formato YYYY-MM-DD (data sem hora). */
function isIsoDateOnly(s) {
  return typeof s === "string" && /^\d{4}-\d{2}-\d{2}$/.test(s);
}

/** Tenta parsear uma string ISO (com ou sem Z). Se vier sem Z, o Date assume local do servidor. */
function parseIsoToDate(s) {
  if (!s || typeof s !== "string") return null;
  const d = new Date(s);
  return isNaN(d) ? null : d;
}

/** Retorna um Date a partir de ISO com Z em UTC (prefer√≠vel). */
function parseUtc(isoUtc) {
  if (!isoUtc) return null;
  // Exige 'Z' no fim para garantir UTC expl√≠cito
  if (typeof isoUtc === "string" && /z$/i.test(isoUtc)) {
    const d = new Date(isoUtc);
    return isNaN(d) ? null : d;
  }
  // Se n√£o tiver Z, tenta parse e assume como Date v√°lido (mas recomendamos sempre enviar com Z)
  const d = new Date(isoUtc);
  return isNaN(d) ? null : d;
}

/** Serializa Date (UTC) para ISO 8601 com 'Z'. */
function toIsoUtc(date) {
  if (!(date instanceof Date) || isNaN(date)) return null;
  return date.toISOString(); // sempre com Z (UTC)
}

/** Converte YYYY-MM-DD para Date "in√≠cio do dia" em UTC. */
function dateOnlyToUtcDate(yyyyMmDd) {
  if (!isIsoDateOnly(yyyyMmDd)) return null;
  // meia-noite UTC
  return new Date(`${yyyyMmDd}T00:00:00Z`);
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   FORMATA√á√ÉO pt-BR PARA EXIBI√á√ÉO (casos em que o backend precise)
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

/** Formata Date/ISO para dd/MM/aaaa no fuso informado (padr√£o: America/Sao_Paulo). */
function toBrDate(input, timeZone = TZ_PADRAO) {
  let d = input instanceof Date ? input : parseIsoToDate(input);
  if (!d) return "";
  return new Intl.DateTimeFormat("pt-BR", {
    timeZone,
    day: "2-digit",
    month: "2-digit",
    year: "numeric",
  }).format(d);
}

/** Formata Date/ISO para dd/MM/aaaa HH:mm (24h) no fuso informado. */
function toBrDateTime(input, timeZone = TZ_PADRAO) {
  let d = input instanceof Date ? input : parseIsoToDate(input);
  if (!d) return "";
  return new Intl.DateTimeFormat("pt-BR", {
    timeZone,
    day: "2-digit",
    month: "2-digit",
    year: "numeric",
    hour: "2-digit",
    minute: "2-digit",
    hour12: false,
  }).format(d);
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   CONVERS√ïES BR (strings do tipo dd/MM/aaaa) ‚Üí ISO
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

/** Converte dd/MM/aaaa para YYYY-MM-DD (somente data). */
function brDateToIsoDate(dataBr) {
  if (!dataBr || typeof dataBr !== "string") return "";
  const [dd, mm, yyyy] = dataBr.split("/").map((x) => String(x || "").trim());
  if (!dd || !mm || !yyyy) return "";
  if (!/^\d{2}$/.test(dd) || !/^\d{2}$/.test(mm) || !/^\d{4}$/.test(yyyy)) return "";
  return `${yyyy}-${mm}-${dd}`;
}

/**
 * Converte dd/MM/aaaa + HH:mm (hora local do servidor) ‚Üí ISO UTC.
 * ‚ö†Ô∏è BACKEND: esta fun√ß√£o usa o timezone do SISTEMA onde o Node est√° rodando.
 * Se voc√™ precisa converter especificamente com "America/Sao_Paulo" independente do servidor,
 * prefira fazer a convers√£o no FRONTEND (onde sabemos a zona do usu√°rio) e enviar ISO UTC pronto.
 */
function brDateTimeToIsoUtc(dataBr, horaBr = "00:00") {
  const isoDate = brDateToIsoDate(dataBr);
  if (!isoDate) return null;

  const [hh, min] = (horaBr || "00:00").split(":").map((x) => parseInt(x, 10));
  const [y, m, d] = isoDate.split("-").map((x) => parseInt(x, 10));

  // Cria Date como LOCAL do servidor (n√£o do usu√°rio), depois converte para UTC via toISOString.
  const local = new Date(y, (m - 1), d, isNaN(hh) ? 0 : hh, isNaN(min) ? 0 : min, 0, 0);
  if (isNaN(local)) return null;
  return local.toISOString(); // retorna UTC com Z
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   COMPATIBILIDADE (mant√©m suas fun√ß√µes antigas)
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

/** (LEGADO) Converte Date ou string ISO para dd/MM/aaaa. */
function formatarDataBR(dataEntrada) {
  if (!dataEntrada) return "";
  // Reaproveita toBrDate (usa TZ padr√£o)
  return toBrDate(dataEntrada);
}

/** (LEGADO) Converte dd/MM/aaaa para YYYY-MM-DD. */
function formatarDataISO(dataBR) {
  return brDateToIsoDate(dataBR);
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   EXPORTS
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

module.exports = {
  // Contrato API (recomendado)
  parseUtc,           // ISO (com Z) -> Date
  toIsoUtc,           // Date -> ISO (com Z)
  dateOnlyToUtcDate,  // "YYYY-MM-DD" -> Date (00:00Z)

  // Formata√ß√£o pt-BR (√∫til em e-mails/logs do backend)
  toBrDate,           // Date/ISO -> "dd/MM/aaaa"
  toBrDateTime,       // Date/ISO -> "dd/MM/aaaa HH:mm"

  // Converters BR <-> ISO date-only
  brDateToIsoDate,    // "dd/MM/aaaa" -> "YYYY-MM-DD"
  brDateTimeToIsoUtc, // "dd/MM/aaaa"+"HH:mm" -> ISO UTC (aten√ß√£o ao timezone do servidor)

  // Legado (mantidos)
  formatarDataBR,
  formatarDataISO,

  // Utils
  isIsoDateOnly,
};
